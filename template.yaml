AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  HackathonTeam8 - Audio Transcription Service using AssemblyAI
Parameters:
  AssemblyAIAPIKey:
    Description: API key to be used when interacting with AssemblyAI
    NoEcho: true
    DataType: String
Globals:
  Function:
    Timeout: 300  # Increased timeout for transcription processing
    MemorySize: 256
    Tracing: Active
    LoggingConfig:
      LogFormat: JSON
  Api:
    TracingEnabled: true

Resources:
  # S3 Buckets
  AudioBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${AWS::StackName}-audio-files'
      NotificationConfiguration:
        LambdaConfigurations:
          - Event: 's3:ObjectCreated:*'
            Function: !GetAtt TranscriptionFunction.Arn

  TranscriptBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${AWS::StackName}-transcripts'

  # Lambda Function
  TranscriptionFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: hello_world/
      Handler: app.lambda_handler
      Runtime: python3.13
      Architectures:
        - x86_64
      Environment:
        Variables:
          TRANSCRIPT_BUCKET: !Ref TranscriptBucket
          ASSEMBLYAI_API_KEY: !Ref AssemblyAIAPIKey
      Policies:
        - S3ReadPolicy:
            BucketName: !Ref AudioBucket
        - S3WritePolicy:
            BucketName: !Ref TranscriptBucket
        - Statement:
            - Effect: Allow
              Action:
                - s3:GetObject
                - s3:PutObject
              Resource:
                - !Sub 'arn:aws:s3:::${AudioBucket}/*'
                - !Sub 'arn:aws:s3:::${TranscriptBucket}/*'

  # S3 Bucket Permissions
  BucketPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref TranscriptionFunction
      Principal: s3.amazonaws.com
      SourceArn: !Sub 'arn:aws:s3:::${AudioBucket}'

Outputs:
  AudioBucketName:
    Description: Name of the S3 bucket for audio files
    Value: !Ref AudioBucket

  TranscriptBucketName:
    Description: Name of the S3 bucket for transcripts
    Value: !Ref TranscriptBucket

  TranscriptionFunctionArn:
    Description: ARN of the transcription Lambda function
    Value: !GetAtt TranscriptionFunction.Arn 
